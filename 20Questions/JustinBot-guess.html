<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>20 Questions with JustinBot</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
  <h1>20 Questions with JustinBot</h1>

  <!-- Question Counter -->
  <div id="question-counter" class="hidden">
    Question <span id="q-number">1</span> / 20
  </div>

  <!-- Chat Display -->
  <div id="chat-box"></div>

  <!-- Yes/No Buttons -->
  <div id="bot-buttons" class="hidden" style="text-align:center; margin-top:16px;">
    <button onclick="submitAnswer('yes')">Yes</button>
    <button onclick="submitAnswer('probably')">Probably</button>
    <button onclick="submitAnswer('probably not')">Probably Not</button>
    <button onclick="submitAnswer('no')">No</button>
    <button onclick="submitAnswer('unknown')">I don't know</button>
  </div>

  <!-- Result Buttons -->
  <div id="win-buttons" style="text-align:center; margin-top:16px;">
    <button onclick="botWins()">JustinBot Guessed It!</button>
    <button id="wrong-btn" class="hidden" onclick="botLoses()">No, wrong</button>
  </div>

  <!-- Music Toggle & Audio -->
  <div id="music-toggle" style="position:fixed; bottom:16px; right:16px;">
    <button onclick="toggleMusic()">ðŸ”Š</button>
  </div>
  <audio id="bg-music" loop>
    <source src="audio/gameboy-theme.mp3" type="audio/mpeg"/>
  </audio>
  <audio id="sfx-blip"    src="audio/blip.mp3"></audio>
  <audio id="sfx-success" src="audio/success.mp3"></audio>
  <audio id="sfx-lose"    src="audio/lose.mp3"></audio>

<script>
  const $ = id => document.getElementById(id);
  const music      = $("bg-music");
  const blipSFX    = $("sfx-blip");
  const successSFX = $("sfx-success");
  const loseSFX    = $("sfx-lose");

  // Perfected Mega 20-Questions decision tree
  const phase1Tree = {
    question: "Is it a living thing?",
    yes: {
      question: "Is it a human?",
      yes: {
        question: "Are they a real person?",
        yes: {
          question: "Is the person currently alive?",
          yes: {
            question: "Are they a public figure?",
            yes: {
              question: "Are they known globally?",
              yes: {
                question: "Are they known for science or innovation?",
                yes: { guess: "Elon Musk" },
                no: {
                  question: "Are they known for politics or government?",
                  yes: { guess: "Barack Obama" },
                  no: {
                    question: "Are they known for entertainment?",
                    yes: {
                      question: "Is it for music?",
                      yes: { guess: "Taylor Swift" },
                      no: {
                        question: "Is it for film or TV?",
                        yes: { guess: "Leonardo DiCaprio" },
                        no: {
                          question: "Is it for sports?",
                          yes: { guess: "Serena Williams" },
                          no: {
                            question: "Is it for literature or art?",
                            yes: {
                              question: "Literature?",
                              yes: { guess: "J.K. Rowling" },
                              no: { guess: "Banksy" }
                            },
                            no: {
                              question: "Is it for business or activism?",
                              yes: { guess: "Warren Buffett" },
                              no:  { guess: "Malala Yousafzai" }
                            }
                          }
                        }
                      }
                    },
                    no: {
                      question: "Are they known regionally?",
                      yes: { guess: "Chimamanda Ngozi Adichie" },
                      no:  { guess: "Private individual" }
                    }
                  }
                }
              },
              no: {
                question: "Are they known nationally?",
                yes: { guess: "Chimamanda Ngozi Adichie" },
                no:  { guess: "Local person" }
              }
            },
            no: {
              question: "Is this someone you know personally?",
              yes: { guess: "A friend or family member" },
              no:  { guess: "An unknown private person" }
            }
          },
          no: {
            question: "Did they contribute significantly to history?",
            yes: {
              question: "Were they active before 1900?",
              yes: { guess: "Albert Einstein" },
              no:  { guess: "Steve Jobs" }
            },
            no: { guess: "Minor historical figure" }
          }
        },
        no: {
          question: "Is it a fictional character?",
          yes: {
            question: "Origin medium?",
            book: { guess: "Harry Potter" },
            film: { guess: "James Bond" },
            tv:   { guess: "Sherlock Holmes" },
            game: { guess: "Mario" },
            comic:{ guess: "Spider-Man" },
            myth: { guess: "Zeus" }
          },
          no: { guess: "Mythical person" }
        }
      },
      no: {
        question: "Is it another kind of animal?",
        yes: {
          question: "Is it a mammal?",
          yes: {
            question: "Is it domesticated?",
            yes: {
              question: "Is it a common pet?",
              yes: {
                question: "Does it meow?",
                yes: { guess: "Cat" },
                no:  {
                  question: "Does it bark?",
                  yes: { guess: "Dog" },
                  no:  { guess: "Parakeet" }
                }
              },
              no: {
                question: "Is it a farm animal?",
                yes: { guess: "Cow" },
                no:  { guess: "Goat" }
              }
            },
            no: {
              question: "Is it wild?",
              yes: {
                question: "Is its habitat aquatic?",
                yes: { guess: "Dolphin" },
                no:  {
                  question: "Is its habitat forest?",
                  yes: { guess: "Tiger" },
                  no:  { guess: "Elephant" }
                }
              },
              no: { guess: "Camel" }
            }
          },
          no: {
            question: "Is it a bird?",
            yes: {
              question: "Can it fly?",
              yes: { guess: "Eagle" },
              no:  { guess: "Penguin" }
            },
            no: {
              question: "Is it a reptile?",
              yes: {
                question: "Slithers?",
                yes: { guess: "Snake" },
                no:  { guess: "Lizard" }
              },
              no: {
                question: "Is it an amphibian?",
                yes: { guess: "Frog" },
                no:  { guess: "Butterfly" }
              }
            }
          }
        },
        no: {
          question: "Is it a plant?",
          yes: {
            question: "Type of plant?",
            flower: { guess: "Rose" },
            tree:   { guess: "Oak Tree" },
            grass:  { guess: "Bamboo" },
            fungus: { guess: "Mushroom" },
            shrub:  { guess: "Holly" }
          },
          no:    { guess: "Algae or moss" }
        }
      }
    },
    no: {
      question: "Is it man-made?",
      yes: {
        question: "Is it electronic?",
        yes: {
          question: "Does it communicate or entertain?",
          yes: {
            question: "Communication or entertainment?",
            communication: { guess: "Phone" },
            entertainment: { guess: "TV" }
          },
          no: {
            question: "Does it tell time?",
            yes: { guess: "Clock" },
            no:  { guess: "Laptop" }
          }
        },
        no: {
          question: "Is it mechanical?",
          yes: {
            question: "Is it a vehicle?",
            yes: {
              question: "Land, air, or water?",
              land: { guess: "Car" },
              air:  { guess: "Airplane" },
              water:{ guess: "Boat" }
            },
            no: {
              question: "Is it a tool or instrument?",
              yes: {
                question: "Hand tool or power tool?",
                hand:  { guess: "Hammer" },
                power: { guess: "Drill" }
              },
              no: {
                question: "Is it furniture, decor, or container?",
                yes: {
                  question: "Which category?",
                  furniture: {
                    question: "Seating, surface or storage?",
                    seating: { guess: "Couch" },
                    surface: { guess: "Table" },
                    storage: { guess: "Chair" }
                  },
                  decor: {
                    question: "Mirror, candle or carpet?",
                    mirror: { guess: "Mirror" },
                    candle:{ guess: "Candle" },
                    carpet:{ guess: "Carpet" }
                  },
                  container: {
                    question: "Cup, bowl or trash can?",
                    cup:       { guess: "Cup" },
                    bowl:      { guess: "Bowl" },
                    trash_can: { guess: "Trash Can" }
                  }
                },
                no: { guess: "Fan" }
              }
            }
          },
          no: {
            question: "Is it clothing or makeup?",
            yes: {
              question: "Clothing or makeup?",
              clothing: { guess: "Shirt" },
              makeup:   { guess: "Makeup" }
            },
            no: { guess: "Unknown object" }
          }
        }
      },
      no: {
        question: "Is it a natural non-living thing?",
        yes: {
          question: "Mineral, element or phenomenon?",
          mineral:    { guess: "Gold" },
          element:    { guess: "Oxygen" },
          phenomenon: { guess: "Lightning" }
        },
        no: {
          question: "Is it an abstract concept?",
          yes: {
            question: "Emotion, time or idea?",
            emotion: { guess: "Love" },
            time:    { guess: "Time" },
            idea:    { guess: "Justice" }
          },
          no: { guess: "Air" }
        }
      }
    }
  };

  // â”€â”€â”€ STATE & CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const GENERAL_END  = 17;
  const SPECIFIC_END = 19;
  const FINAL_Q      = 20;

  let qNum         = 1;
  let history      = [];
  let currentNode  = phase1Tree;
  let pendingGuess = false;
  let currentQ     = phase1Tree.question;
  let musicStarted = false;
  let askedSet     = new Set([currentQ]);

  // â”€â”€â”€ AUDIO CONTROL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.body.addEventListener("click", ()=>{
    if(!musicStarted){ music.play(); musicStarted=true; }
  });
  function play(sfx){ sfx.pause(); sfx.currentTime=0; sfx.play(); }
  function toggleMusic(){
    const btn = $("music-toggle").querySelector("button");
    if(music.paused){ music.play(); btn.textContent="ðŸ”Š"; }
    else            { music.pause(); btn.textContent="ðŸ”‡"; }
  }

  // â”€â”€â”€ UI HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updateCounter(){
    $("q-number").textContent = qNum;
    $("question-counter").classList.remove("hidden");
  }
  function addEntry(who, txt){
    const p = document.createElement("p");
    p.innerHTML = `<strong>${who}:</strong> ${txt}`;
    $("chat-box").appendChild(p);
    $("chat-box").scrollTop = $("chat-box").scrollHeight;
  }
  function mapAnswer(ans){
    const a = ans.toLowerCase();
    if(a.startsWith("yes") || a==="probably") return "yes";
    if(a.startsWith("no")  || a==="probably not") return "no";
    return Math.random()>0.5 ? "yes" : "no";
  }
  function getTraitLists(){
    const yes = history.filter(h=>h.a.startsWith("y")).map(h=>h.q).join("; ")||"none";
    const no  = history.filter(h=>h.a.startsWith("n")).map(h=>h.q).join("; ")||"none";
    return {yes,no};
  }

  // â”€â”€â”€ DYNAMIC LLM FALLBACKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function askLLMQuestion(){
    const {yes,no} = getTraitLists();
    const prompt = 
      `The thing is: ${yes}.\n`+
      `The thing is NOT: ${no}.\n`+
      `Do NOT repeat any previous question.\n`+
      `Ask exactly one yes/no question to narrow it down.\n`+
      `Respond with only that question.\n\nHistory:\n`+
      history.map(h=>`Q: ${h.q}\nA: ${h.a}`).join("\n");
    const res = await fetch("https://justin-bot-ujmo.onrender.com/ask", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({question:prompt})
    }).then(r=>r.json());
    let q = res.answer.trim();
    if(askedSet.has(q)) return askLLMQuestion();
    askedSet.add(q);
    currentNode = null;
    currentQ    = q;
    addEntry("Q"+qNum, q);
    play(blipSFX);
  }

  async function askLLMGuess(final=false){
    const {yes,no} = getTraitLists();
    const instr = final
      ? `Final guess: [item]. Respond with only "Final guess: [item]".`
      : `Based on that, make your best single guess.\nRespond with exactly "Is it [item]?"`;
    const prompt =
      `The thing is: ${yes}.\n`+
      `The thing is NOT: ${no}.\n`+
      instr + `\n\nHistory:\n`+
      history.map(h=>`Q: ${h.q}\nA: ${h.a}`).join("\n");
    const res = await fetch("https://justin-bot-ujmo.onrender.com/ask", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({question:prompt})
    }).then(r=>r.json());
    let g = res.answer.trim();
    if(askedSet.has(g)) return askLLMGuess(final);
    askedSet.add(g);
    currentNode = null;
    currentQ    = g;
    pendingGuess = !final;
    addEntry("Q"+qNum, g);
    play(blipSFX);
    if(final) play(loseSFX);
  }

  // â”€â”€â”€ GAME FLOW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function startGame(){
    $("chat-box").innerHTML = "";
    $("bot-buttons").classList.remove("hidden");
    $("wrong-btn").classList.add("hidden");
    $("question-counter").classList.remove("hidden");
    qNum = 1; history = []; currentNode = phase1Tree;
    pendingGuess = false; currentQ = phase1Tree.question;
    askedSet = new Set([currentQ]);
    addEntry("JustinBot","I'm ready! Think of somethingâ€¦ and answer honestly. ðŸ˜Ž");
    addEntry("Q1", currentQ);
    play(blipSFX);
    updateCounter();
  }
  window.onload = startGame;

  function botWins(){
    $("bot-buttons").classList.add("hidden");
    addEntry("JustinBot","Haha! I win again! ðŸ˜Ž");
    play(successSFX);
  }
  function botLoses(){
    $("bot-buttons").classList.add("hidden");
    addEntry("JustinBot","Dang, you got me. ðŸ˜… Thanks for playing!");
    play(loseSFX);
  }

  async function submitAnswer(ans){
    addEntry("You", ans);
    history.push({q:currentQ, a:ans.toLowerCase()});

    // ONLY win when it was explicitly posed as a guess
    if (pendingGuess && ans.toLowerCase().startsWith("y")) {
      return botWins();
    }
    pendingGuess = false;

    // â”€â”€ STATIC TREE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (currentNode && currentNode.question) {
      const branch = mapAnswer(ans);
      const next   = currentNode[branch] || null;

      if (next && next.guess) {
        // static guess â†’ show and clear so it wonâ€™t repeat
        qNum++; updateCounter();
        currentQ     = `Is it ${next.guess}?`;
        pendingGuess = true;
        currentNode  = null;
        askedSet.add(currentQ);
        addEntry("Q"+qNum, currentQ);
        play(blipSFX);
        return;
      }
      if (next && next.question) {
        // static deeper
        currentNode = next;
        qNum++; updateCounter();
        currentQ = next.question;
        askedSet.add(currentQ);
        addEntry("Q"+qNum, currentQ);
        play(blipSFX);
        return;
      }
      // fell off that branch â†’ go LLM
      currentNode = null;
      qNum++; updateCounter();
      return askLLMQuestion();
    }

   // â”€â”€ DYNAMIC FALLBACK (exactly 2 guesses then final) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   // 1) Narrowing questions until GENERAL_END (e.g. 17)
   if (qNum < GENERAL_END) {
     qNum++; updateCounter();
     return askLLMQuestion();
   }
   // 2) First dynamic guess at Q18
   if (qNum === GENERAL_END) {
     qNum++; updateCounter();
     return askLLMGuess(false);
   }
   // 3) Second dynamic guess at Q19
   if (qNum === GENERAL_END + 1) {
     qNum++; updateCounter();
     return askLLMGuess(false);
   }
   // 4) Final guess at Q20
   if (qNum === GENERAL_END + 2) {
     qNum++; updateCounter();
     $("bot-buttons").classList.add("hidden");
     $("wrong-btn").classList.remove("hidden");
     return askLLMGuess(true);
   }
  }
</script>
</body>
</html>
