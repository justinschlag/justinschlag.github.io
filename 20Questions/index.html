<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>20 Questions with JustinBot</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <!-- Back to Home Button -->
  <div id="back-home" class="always-visible">
    <a href="../index.html" class="nav-link">‚Üê Back to Home</a>
  </div>

  <h1>20 Questions with JustinBot</h1>

  <!-- Mode Selection -->
  <div id="mode-selection">
    <h2>Who should guess?</h2>
    <button onclick="startGame('bot')">JustinBot Guesses</button>
    <button onclick="startGame('user')">You Guess</button>
  </div>

  <!-- Question Counter -->
  <div id="question-counter" class="hidden">
    Question <span id="q-number">1</span> / 20
  </div>

  <!-- Chat Box -->
  <div id="chat-box"></div>

  <!-- Bot Answer Buttons -->
  <div id="bot-buttons" class="hidden">
    <button onclick="submitAnswer('yes')">Yes</button>
    <button onclick="submitAnswer('probably')">Probably</button>
    <button onclick="submitAnswer('probably not')">Probably Not</button>
    <button onclick="submitAnswer('no')">No</button>
    <button onclick="submitAnswer('unknown')">I don't know</button>
  </div>

  <!-- User Input -->
  <div id="user-input-container" class="hidden">
    <input type="text" id="user-input" placeholder="Type your question...">
    <button onclick="submitUserQuestion()">Send</button>
  </div>

  <!-- Win Buttons -->
  <div id="win-buttons" class="hidden">
    <button id="btn-bot-wins" onclick="botWins()">JustinBot Guessed It!</button>
  </div>

  <!-- Sound Effects -->
  <audio id="blip" src="https://freesound.org/data/previews/64/64614_634166-lq.mp3"></audio>
  <audio id="click" src="https://freesound.org/data/previews/170/170523_2394245-lq.mp3"></audio>
  <audio id="success" src="https://freesound.org/data/previews/435/435396_5121236-lq.mp3"></audio>
  <audio id="bgmusic" src="https://freesound.org/data/previews/391/391539_5121236-lq.mp3" loop autoplay></audio>

<script>
let qNum = 1;
let phase = 1;
let mode = null;
let history = [];
let finalGuesses = new Set();
let askedTraits = new Set();
let currentNode = null;
let currentQuestion = "";

const traitPool = [
  "used in an office", "used for entertainment", "used in kitchen", "decorative",
  "edible", "emits light", "produces sound", "portable", "used for communication",
  "associated with technology", "used outdoors", "found in homes", "used by children",
  "used by professionals", "part of clothing", "transport-related", "made of metal",
  "made of plastic", "has moving parts", "requires power source", "connects to the internet"
];

const phase1Tree = {
  question: "Is it a living thing?",
  yes: {
    question: "Is it a person?",
    yes: {
      question: "Are they a celebrity?",
      yes: { question: "Are they an entertainer (actor, singer, etc.)?" },
      no: { question: "Are they known for politics or science?" }
    },
    no: {
      question: "Is it a mammal?",
      yes: { question: "Is it a domesticated animal?" },
      no: { question: "Is it an insect or bird?" }
    }
  },
  no: {
    question: "Is it man-made?",
    yes: {
      question: "Is it electronic?",
      yes: {
        question: "Is it used for communication?",
        yes: { question: "Is it handheld?" },
        no: { question: "Is it larger than a microwave?" }
      },
      no: {
        question: "Is it used daily?",
        yes: { question: "Is it found in a home?" },
        no: { question: "Is it a tool or instrument?" }
      }
    },
    no: {
      question: "Is it found in nature?",
      yes: { question: "Is it a mineral or geological object?" },
      no: { question: "Is it fictional?" }
    }
  }
};

const $ = id => document.getElementById(id);
const updateCounter = () => $('q-number').textContent = qNum;
const addEntry = (who, msg) => {
  const p = document.createElement('p');
  p.classList.add('fade-in');
  p.innerHTML = `<strong>${who}:</strong> ${msg}`;
  $('chat-box').appendChild(p);
  $('chat-box').scrollTop = $('chat-box').scrollHeight;
};

function startGame(chosen) {
  mode = chosen;
  $('mode-selection').classList.add('hidden');
  $('question-counter').classList.remove('hidden');
  $('chat-box').innerHTML = '';
  $('win-buttons').classList.remove('hidden');
  $('q-number').textContent = '1';
  $('bot-buttons').classList.toggle('hidden', mode !== 'bot');
  $('user-input-container').classList.toggle('hidden', mode !== 'user');
  $('btn-bot-wins').style.display = mode === 'bot' ? 'inline-block' : 'none';

  qNum = 1;
  history = [];
  phase = 1;
  askedTraits.clear();
  finalGuesses.clear();
  updateCounter();

  if (mode === 'bot') {
    currentNode = phase1Tree;
    currentQuestion = currentNode.question;
    addEntry("JustinBot", "I'm ready! Think of something... and answer my questions with honesty. üòé");
    askCurrent();
  } else {
    addEntry("JustinBot", "I'm thinking of something! Ask yes/no questions to guess it.");
  }
}

function submitAnswer(ans) {
  playSound('click');
  addEntry("You", ans);
  history.push({ q: currentQuestion, a: ans });
  qNum++; updateCounter();

  if (qNum <= 10) {
    handlePhase1(ans);
  } else if (qNum <= 16) {
    handlePhase2();
  } else {
    handleFinalGuess();
  }
}

function handlePhase1(answer) {
  const branch = mapAnswer(answer);
  currentNode = currentNode?.[branch];
  if (currentNode && currentNode.question) {
    currentQuestion = currentNode.question;
    askCurrent();
  } else {
    handlePhase2();
  }
}

function handlePhase2() {
  const remaining = traitPool.filter(t => !askedTraits.has(t));
  if (remaining.length === 0) return handleFinalGuess();
  const trait = remaining[Math.floor(Math.random() * remaining.length)];
  askedTraits.add(trait);
  currentQuestion = `Is it ${trait}?`;
  askCurrent();
}

function handleFinalGuess() {
  const past = history.map(h => `Q: ${h.q}\nA: ${h.a}`).join('\n');
  const guesses = [...finalGuesses].map(g => `Already guessed: ${g}`).join('\n');
  const prompt = `You're JustinBot playing 20 Questions. Here's the conversation so far:\n${past}\n${guesses}\nNow ask a very specific guess (object or person).`;

  fetch("https://justin-bot-ujmo.onrender.com/ask", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ question: prompt })
  })
    .then(res => res.json())
    .then(data => {
      const guess = data.answer.trim();
      if (!finalGuesses.has(guess)) {
        finalGuesses.add(guess);
        addEntry("JustinBot", `Final guess: ${guess}`);
      }
    });

  if (qNum >= 20) {
    setTimeout(() => {
      addEntry("JustinBot", "You beat me this time... üëæ Thanks for playing!");
    }, 1000);
  }
}

function askCurrent() {
  playSound('blip');
  addEntry("Q" + qNum, currentQuestion);
}

function submitUserQuestion() {
  const input = $('user-input');
  const question = input.value.trim();
  if (!question) return;
  input.value = '';
  addEntry("You", question);
  fetch("https://justin-bot-ujmo.onrender.com/ask", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ question })
  })
    .then(res => res.json())
    .then(data => addEntry("JustinBot", data.answer));
  qNum++; updateCounter();
}

function botWins() {
  playSound('success');
  addEntry("JustinBot", "Haha! I win again! üòé");
}

function mapAnswer(ans) {
  if (ans === "yes" || ans === "probably") return "yes";
  if (ans === "no" || ans === "probably not") return "no";
  return Math.random() > 0.5 ? "yes" : "no";
}

function playSound(id) {
  const audio = document.getElementById(id);
  if (audio) {
    audio.currentTime = 0;
    audio.play();
  }
}
</script>
</body>
</html>
